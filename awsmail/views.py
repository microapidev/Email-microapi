from rest_framework.views import APIView
from rest_framework.response import Response
from api.serializers import MailSerializer, MailAttachmentSerializer
from drf_yasg.utils import swagger_auto_schema
from django.http import JsonResponse
from rest_framework import status
from awsmail.tasks import send_aws_mail, send_aws_mail_attachment
from rest_framework.parsers import MultiPartParser, FormParser

MAIL_RESPONSES = {
	'200': 'Mail sent successfully.',
	'400': 'Incorrect request format.',
	'500': 'An error occurred, could not send email.' 
}

"""
Send email using AWS Simple Email Service (SES)
"""

class AwsMailView(APIView):
	@swagger_auto_schema(
		request_body=MailSerializer,
		operation_description="Send email using AMAZON SES",
		operation_summary="Sending email with AMAZON SES",
		responses=MAIL_RESPONSES,
		tags=['Email with Amazon SES']
	)
	def post(self, request, *args, **kwargs):
		serializer = MailSerializer(data=request.data)
		if serializer.is_valid():
			subject = serializer.validated_data.get('subject')
			body = serializer.validated_data.get('body')
			sender = serializer.validated_data.get('sender')
			recipient = serializer.validated_data.get('recipient')

			send_aws_mail.delay(subject, body, sender, recipient)
			
			return Response({
					'message': 'Mail Sent Successfully',
                    'success': True,
                }, status=status.HTTP_200_OK)
		else:
			return Response({
				'message': 'Incorrect request format.', 
				'errors': serializer.errors,
				'success': False,
			}, status=status.HTTP_400_BAD_REQUEST)
			

class AwsMailAttachmentView(APIView):
	parser_classes = (MultiPartParser, FormParser,)

	@swagger_auto_schema(
		request_body=MailAttachmentSerializer,
		operation_description="Send email using AMAZON SES with attachment",
		operation_summary="Sending email with AMAZON SES with attachment",
		responses=MAIL_RESPONSES,
		tags=['Send Mail with attachment']
	)
	def post(self, request, *args, **kwargs):
		serializer = MailAttachmentSerializer(data=request.data)
	
		if serializer.is_valid():
			subject = serializer.validated_data.get('subject')
			body = serializer.validated_data.get('body')
			sender = serializer.validated_data.get('sender')
			recipient = serializer.validated_data.get('recipient')
			attach = request.FILES['attach']

			send_aws_mail_attachment(subject, body, sender, recipient, attach)
			
			return Response({
                    'message': 'Mail Sent Successfully',
                    'success': True,
                }, status=status.HTTP_200_OK)
		else:
			return Response({
				'message': 'Incorrect request format.',
				'errors': serializer.errors,
				'success': False,
				}, status=status.HTTP_400_BAD_REQUEST)
